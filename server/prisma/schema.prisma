generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma2/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentType {
  SOP
  POLICY
  WORK_INSTRUCTION
  FORM
  OTHER
}

enum DocumentStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PENDING_APPROVAL
  PENDING_QUALITY_RELEASE
  EFFECTIVE
  OBSOLETE
  ARCHIVED
}

enum AssignmentTaskType {
  REVIEW
  APPROVAL
  QUALITY_RELEASE
}

enum AssignmentStatus {
  PENDING
  COMPLETED
  REJECTED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

model Role {
  id             Int             @id @default(autoincrement())
  name           String          @unique
  permissions    String[]        @default([])
  users          User[]
  rolePermissions RolePermission[]
}

model Permission {
  id          String         @id @default(uuid())
  code        String         @unique // e.g. users:create, auditlog:view
  description String?        @db.Text
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int       @map("role_id")
  permissionId String    @map("permission_id")
  role         Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String?  @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  users         User[]
  capas         CAPA[]
  changeControls ChangeControl[]

  @@map("departments")
}

model Site {
  id        String   @id @default(uuid())
  name      String
  code      String?  @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  users          User[]
  capas          CAPA[]
  changeControls ChangeControl[]

  @@map("sites")
}

model JobTitle {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("job_titles")
}

model User {
  id                String      @id @default(uuid())
  firstName         String      @map("first_name")
  lastName          String      @map("last_name")
  email             String      @unique
  password          String
  roleId            Int         @map("role_id")
  role              Role        @relation(fields: [roleId], references: [id], onDelete: Restrict)
  departmentId      String?     @map("department_id")
  siteId            String?     @map("site_id")
  jobTitle          String?     @map("job_title")
  status            UserStatus  @default(ACTIVE)
  mfaEnabled        Boolean     @default(false) @map("mfa_enabled")
  lastLoginAt       DateTime?   @map("last_login_at")
  lockedAt          DateTime?   @map("locked_at")
  mustChangePassword Boolean    @default(false) @map("must_change_password")
  invitedAt         DateTime?   @map("invited_at")
  tokenVersion      Int         @default(0) @map("token_version")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  department        Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  site              Site?       @relation(fields: [siteId], references: [id], onDelete: SetNull)
  documentsAuthored    Document[]          @relation("DocumentAuthor")
  documentHistoryItems DocumentHistory[]
  documentAssignments  DocumentAssignment[] @relation("DocumentAssignee")
  notifications        Notification[]
  documentRevisions    DocumentRevision[]
  documentSignatures   DocumentSignature[]
  changeControls       ChangeControl[]   @relation("ChangeControlInitiator")
  changeControlsOwned  ChangeControl[]   @relation("ChangeControlOwner")
  changeControlTasksAssigned ChangeControlTask[] @relation("ChangeTaskAssignee")
  changeControlTasksCompleted ChangeControlTask[] @relation("ChangeTaskCompletedBy")
  changeControlTasksCreated ChangeControlTask[] @relation("ChangeTaskCreatedBy")
  changeControlHistoryItems ChangeControlHistory[]
  changeControlSignatures   ChangeControlSignature[]
  capasAssigned        CAPA[]            @relation("CAPAAssignee")
  capasInitiated       CAPA[]            @relation("CAPAInitiator")
  capasOwned           CAPA[]            @relation("CAPAOwner")
  capaTasksAssigned    CapaTask[]        @relation("CapaTaskAssignee")
  capaTasksCompleted   CapaTask[]        @relation("CapaTaskCompletedBy")
  capaTasksCreated     CapaTask[]        @relation("CapaTaskCreatedBy")
  capaHistoryItems     CapaHistory[]
  capaSignatures       CapaSignature[]
  fileAssetsUploaded   FileAsset[]
  trainingRecords      UserTrainingRecord[]
  documentComments     DocumentComment[]
  periodicReviews      PeriodicReview[]
  auditLogs             AuditLog[]        @relation("AuditLogUser")
  inviteTokensCreated   InviteToken[]     @relation("InviteTokenCreator")
  passwordResetTokens   PasswordResetToken[]
  formRecordsCreated    FormRecord[]      @relation("FormRecordCreatedBy")
  formRecordsUpdated    FormRecord[]      @relation("FormRecordUpdatedBy")
  formRecordsFinalized  FormRecord[]      @relation("FormRecordFinalizedBy")
  signatureRequestsCreated SignatureRequest[]

  @@map("users")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  beforeValue Json?   @map("before_value")
  afterValue  Json?   @map("after_value")
  reason     String?  @db.Text
  ip         String?
  userAgent  String?  @map("user_agent")
  requestId  String?  @map("request_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation("AuditLogUser", fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

model InviteToken {
  id         String    @id @default(uuid())
  email      String
  tokenHash  String    @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdById String   @map("created_by_id")
  createdAt  DateTime  @default(now()) @map("created_at")

  createdBy User @relation("InviteTokenCreator", fields: [createdById], references: [id], onDelete: Restrict)

  @@map("invite_tokens")
}

model PasswordResetToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("password_reset_tokens")
}

model SecurityPolicy {
  id        String   @id @default(uuid())
  passwordMinLength     Int      @default(8) @map("password_min_length")
  passwordRequireUppercase Boolean @default(true) @map("password_require_uppercase")
  passwordRequireLowercase Boolean @default(true) @map("password_require_lowercase")
  passwordRequireNumber   Boolean @default(true) @map("password_require_number")
  passwordRequireSpecial  Boolean @default(true) @map("password_require_special")
  passwordHistoryCount    Int     @default(5) @map("password_history_count")
  passwordMaxAgeDays      Int?    @map("password_max_age_days")
  lockoutThreshold        Int     @default(5) @map("lockout_threshold")
  lockoutDurationMinutes  Int     @default(30) @map("lockout_duration_minutes")
  sessionIdleTimeoutMinutes Int   @default(30) @map("session_idle_timeout_minutes")
  sessionMaxDurationMinutes Int  @default(480) @map("session_max_duration_minutes")
  mfaPolicy               String  @default("OPTIONAL") @map("mfa_policy") // OFF, OPTIONAL, REQUIRED
  allowedDomains          String[] @default([]) @map("allowed_domains")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("security_policies")
}

model RetentionPolicy {
  id                      String   @id @default(uuid())
  auditLogRetentionYears  Int      @default(7) @map("audit_log_retention_years")
  documentRetentionYears  Int?     @map("document_retention_years")
  trainingRetentionYears Int?     @map("training_retention_years")
  capaRetentionYears      Int?     @map("capa_retention_years")
  changeRetentionYears    Int?     @map("change_retention_years")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("retention_policies")
}

model ESignConfig {
  id                         String   @id @default(uuid())
  requireForDocumentApproval Boolean  @default(true) @map("require_for_document_approval")
  requireForCapaClosure      Boolean  @default(true) @map("require_for_capa_closure")
  requireForCapaPlanApproval Boolean  @default(true) @map("require_for_capa_plan_approval")
  requireForTrainingSignOff  Boolean  @default(true) @map("require_for_training_sign_off")
  requireForChangeApproval   Boolean  @default(true) @map("require_for_change_approval")
  requireForChangeClosure    Boolean  @default(true) @map("require_for_change_closure")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  @@map("esign_config")
}

model Document {
  id                   String         @id @default(uuid())
  documentId           String         @map("doc_id") // e.g. MAC-SOP-014
  title                String
  documentType         DocumentType   @map("doc_type")
  versionMajor         Int            @default(1) @map("major_version")
  versionMinor         Int            @default(0) @map("minor_version")
  effectiveDate        DateTime?      @map("effective_date")
  status               DocumentStatus @default(DRAFT)
  content              String?        @db.Text
  authorId             String         @map("author_id")
  supersedesDocumentId String?        @map("supersedes_document_id")
  tags                 String[]       @default([])
  nextReviewDate       DateTime?      @map("next_review_date")
  isUnderReview        Boolean        @default(false) @map("is_under_review")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  author              User                @relation("DocumentAuthor", fields: [authorId], references: [id], onDelete: Restrict)
  supersedesDocument  Document?           @relation("DocumentSupersedes", fields: [supersedesDocumentId], references: [id], onDelete: SetNull)
  supersededBy        Document[]          @relation("DocumentSupersedes")
  history             DocumentHistory[]
  revisions           DocumentRevision[]
  signatures          DocumentSignature[]
  assignments         DocumentAssignment[]
  linksAsSource       DocumentLink[]      @relation("DocumentLinkSource")
  linksAsTarget       DocumentLink[]      @relation("DocumentLinkTarget")
  comments            DocumentComment[]
  trainingModules     TrainingModule[]
  periodicReviews     PeriodicReview[]
  formRecordsAsTemplate FormRecord[]

  @@map("documents")
  @@index([documentId])
  @@unique([documentId, versionMajor, versionMinor], map: "document_version_unique")
}

enum DocumentCommentStatus {
  OPEN
  RESOLVED
  REJECTED
}

enum TrainingRecordStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum PeriodicReviewStatus {
  PENDING
  COMPLETED
  OVERDUE
}

model DocumentLink {
  id               String   @id @default(uuid())
  sourceDocumentId String   @map("source_document_id")
  targetDocumentId String   @map("target_document_id")
  linkType         String   @map("link_type") // references, impacts, supersedes
  createdAt        DateTime @default(now()) @map("created_at")

  sourceDocument Document @relation("DocumentLinkSource", fields: [sourceDocumentId], references: [id], onDelete: Restrict)
  targetDocument Document @relation("DocumentLinkTarget", fields: [targetDocumentId], references: [id], onDelete: Restrict)

  @@map("document_links")
}

model TrainingModule {
  id           String   @id @default(uuid())
  documentId   String   @map("document_id")
  title        String
  description  String   @db.Text
  requiredRoles String[] @map("required_roles")
  dueDate      DateTime @map("due_date")
  createdAt    DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  records  UserTrainingRecord[]

  @@map("training_modules")
}

model UserTrainingRecord {
  id               String              @id @default(uuid())
  trainingModuleId String             @map("training_module_id")
  userId           String              @map("user_id")
  status           TrainingRecordStatus @default(ASSIGNED)
  completionDate   DateTime?           @map("completion_date")
  score            Int?
  assignedAt       DateTime            @default(now()) @map("assigned_at")

  trainingModule TrainingModule @relation(fields: [trainingModuleId], references: [id], onDelete: Restrict)
  user           User           @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("user_training_records")
}

model DocumentComment {
  id               String               @id @default(uuid())
  documentId       String               @map("document_id")
  userId           String               @map("user_id")
  commentText      String               @map("comment_text") @db.Text
  sectionIdentifier String?             @map("section_identifier")
  status           DocumentCommentStatus @default(OPEN)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("document_comments")
}

model PeriodicReview {
  id          String               @id @default(uuid())
  documentId  String                @map("document_id")
  reviewDate  DateTime              @map("review_date")
  status      PeriodicReviewStatus  @default(PENDING)
  reviewerId  String                @map("reviewer_id")
  createdAt   DateTime             @default(now()) @map("created_at")
  completedAt DateTime?            @map("completed_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  reviewer User     @relation(fields: [reviewerId], references: [id], onDelete: Restrict)

  @@map("periodic_reviews")
}

model DocumentHistory {
  id               String   @id @default(uuid())
  documentId       String   @map("document_id")
  userId           String   @map("user_id")
  action           String
  timestamp        DateTime @default(now())
  details          Json?
  digitalSignature Json?    @map("digital_signature")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("document_history")
}

model DocumentRevision {
  id              String   @id @default(uuid())
  documentId      String   @map("document_id")
  versionMajor    Int      @map("version_major")
  versionMinor    Int      @map("version_minor")
  effectiveDate   DateTime @map("effective_date")
  authorId        String   @map("author_id")
  summaryOfChange String   @map("summary_of_change")
  createdAt       DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  author   User     @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@map("document_revisions")
}

model DocumentSignature {
  id               String   @id @default(uuid())
  documentId       String   @map("document_id")
  signerId         String   @map("signer_id")
  signatureMeaning String   @map("signature_meaning")
  signedAt         DateTime @default(now()) @map("signed_at")
  documentHash     String   @map("document_hash")
  signatureHash    String   @map("signature_hash")
  passwordHash     String   @map("password_hash")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  signer   User     @relation(fields: [signerId], references: [id], onDelete: Restrict)

  @@map("document_signatures")
}

model DocumentAssignment {
  id            String                  @id @default(uuid())
  documentId    String                  @map("document_id")
  assignedToId  String                  @map("assignee_id")
  assignmentType AssignmentTaskType  @map("task_type")
  status        AssignmentStatus     @default(PENDING)
  dueDate       DateTime?               @map("due_date")
  completedAt   DateTime?               @map("completed_at")
  comments    String?            @db.Text
  createdAt   DateTime           @default(now()) @map("created_at")

  document   Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  assignedTo User     @relation("DocumentAssignee", fields: [assignedToId], references: [id], onDelete: Restrict)

  @@map("document_assignments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  message   String
  read      Boolean  @default(false) @map("is_read")
  link      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("notifications")
}

enum ChangeType {
  PROCESS
  DOCUMENT
  SOFTWARE
  INFRASTRUCTURE
  EQUIPMENT
  SUPPLIER
  TRAINING
  OTHER
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ChangeControlStatus {
  DRAFT
  SUBMITTED
  REVIEW
  APPROVAL
  IMPLEMENTATION
  EFFECTIVENESS
  PENDING_CLOSURE
  CLOSED
  CANCELLED
  ARCHIVED
}

enum ChangeTaskType {
  IMPACT_ASSESSMENT
  REVIEW
  APPROVAL
  IMPLEMENTATION
  TRAINING
  EFFECTIVENESS_CHECK
  CLOSURE_REVIEW
}

enum ChangeTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  OVERDUE
}

model ChangeControl {
  id                  String               @id @default(uuid())
  changeId            String               @unique @map("change_id")
  title               String
  description         String               @db.Text
  riskAssessment      String?              @map("risk_assessment") @db.Text
  changeType          ChangeType?          @map("change_type")
  riskLevel           RiskLevel?           @map("risk_level")
  implementationPlan  String?              @map("implementation_plan") @db.Text
  verificationSummary String?              @map("verification_summary") @db.Text
  effectiveDate       DateTime?            @map("effective_date")
  status              ChangeControlStatus  @default(DRAFT)
  initiatorId         String?              @map("initiator_id")
  ownerId             String?              @map("owner_id")
  siteId              String?              @map("site_id")
  departmentId        String?              @map("department_id")
  dueDate             DateTime?            @map("due_date")
  closedAt            DateTime?            @map("closed_at")
  isArchived          Boolean              @default(false) @map("is_archived")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  initiator  User?   @relation("ChangeControlInitiator", fields: [initiatorId], references: [id], onDelete: SetNull)
  owner      User?   @relation("ChangeControlOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  site       Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  tasks      ChangeControlTask[]
  history    ChangeControlHistory[]
  signatures ChangeControlSignature[]

  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
  @@index([changeType])
  @@map("change_controls")
}

model ChangeControlTask {
  id              String           @id @default(uuid())
  changeControlId String           @map("change_control_id")
  taskType        ChangeTaskType   @map("task_type")
  status          ChangeTaskStatus @default(PENDING)
  stepNumber      Int              @default(0) @map("step_number")
  title           String
  description     String?          @db.Text
  assignedToId    String?          @map("assigned_to_id")
  dueDate         DateTime?        @map("due_date")
  completedAt     DateTime?        @map("completed_at")
  completionNotes String?          @map("completion_notes") @db.Text
  completedById   String?          @map("completed_by_id")
  requiresEsign   Boolean          @default(false) @map("requires_esign")
  createdById     String?          @map("created_by_id")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  changeControl ChangeControl @relation(fields: [changeControlId], references: [id], onDelete: Restrict)
  assignedTo    User?         @relation("ChangeTaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  completedBy   User?         @relation("ChangeTaskCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  createdBy     User?         @relation("ChangeTaskCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([changeControlId])
  @@index([assignedToId])
  @@index([status])
  @@map("change_control_tasks")
}

model ChangeControlHistory {
  id               String   @id @default(uuid())
  changeControlId  String   @map("change_control_id")
  userId           String   @map("user_id")
  action           String
  timestamp        DateTime @default(now())
  details          Json?

  changeControl ChangeControl @relation(fields: [changeControlId], references: [id], onDelete: Restrict)
  user          User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([changeControlId])
  @@map("change_control_history")
}

model ChangeControlSignature {
  id               String   @id @default(uuid())
  changeControlId  String   @map("change_control_id")
  signerId         String   @map("signer_id")
  signatureMeaning String   @map("signature_meaning")
  signedAt         DateTime @default(now()) @map("signed_at")
  recordHash       String   @map("record_hash")
  signatureHash    String   @map("signature_hash")
  passwordHash     String?  @map("password_hash")

  changeControl ChangeControl @relation(fields: [changeControlId], references: [id], onDelete: Restrict)
  signer        User          @relation(fields: [signerId], references: [id], onDelete: Restrict)

  @@map("change_control_signatures")
}

enum CapaStatus {
  DRAFT
  OPEN
  CONTAINMENT
  INVESTIGATION
  RCA_COMPLETE
  PLAN_APPROVAL
  IMPLEMENTATION
  EFFECTIVENESS_CHECK
  PENDING_CLOSURE
  CLOSED
  CANCELLED
  ARCHIVED
}

enum CapaTaskType {
  CONTAINMENT_ACTION
  INVESTIGATION_STEP
  ROOT_CAUSE_ANALYSIS
  CORRECTIVE_ACTION
  PREVENTIVE_ACTION
  EFFECTIVENESS_CHECK
  APPROVAL
  CLOSURE_REVIEW
}

enum CapaTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  OVERDUE
}

enum LinkEntityType {
  DOCUMENT
  CAPA
  CHANGE_CONTROL
  TRAINING_MODULE
}

model CAPA {
  id                   String      @id @default(uuid())
  capaId               String      @unique @map("capa_id")
  title                String
  description          String      @db.Text
  status               CapaStatus  @default(DRAFT)
  initiatorId          String?     @map("initiator_id")
  ownerId              String?     @map("owner_id")
  assigneeId           String?     @map("assignee_id")
  severity             String?     // e.g. Minor, Major, Critical
  siteId               String?     @map("site_id")
  departmentId         String?     @map("department_id")
  rootCause            String?     @map("root_cause") @db.Text
  containmentSummary  String?     @map("containment_summary") @db.Text
  correctiveSummary   String?     @map("corrective_summary") @db.Text
  preventiveSummary   String?     @map("preventive_summary") @db.Text
  effectivenessPlan   String?     @map("effectiveness_plan") @db.Text
  effectivenessResult String?     @map("effectiveness_result") @db.Text
  dueDate              DateTime?   @map("due_date")
  closedAt             DateTime?   @map("closed_at")
  isArchived           Boolean     @default(false) @map("is_archived")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  initiator  User?   @relation("CAPAInitiator", fields: [initiatorId], references: [id], onDelete: SetNull)
  owner      User?   @relation("CAPAOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  assignee   User?   @relation("CAPAAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  site       Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  tasks      CapaTask[]
  history    CapaHistory[]
  signatures CapaSignature[]

  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
  @@map("capas")
}

model CapaTask {
  id             String         @id @default(uuid())
  capaId         String         @map("capa_id")
  taskType       CapaTaskType    @map("task_type")
  status         CapaTaskStatus  @default(PENDING)
  stepNumber     Int             @default(0) @map("step_number")
  title          String
  description    String?         @db.Text
  assignedToId   String?         @map("assigned_to_id")
  dueDate        DateTime?       @map("due_date")
  completedAt    DateTime?       @map("completed_at")
  completionNotes String?        @map("completion_notes") @db.Text
  requiresEsign  Boolean         @default(false) @map("requires_esign")
  completedById  String?         @map("completed_by_id")
  createdById    String?         @map("created_by_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  capa        CAPA   @relation(fields: [capaId], references: [id], onDelete: Restrict)
  assignedTo  User?  @relation("CapaTaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  completedBy User?  @relation("CapaTaskCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  createdBy   User?  @relation("CapaTaskCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([capaId])
  @@index([assignedToId])
  @@index([status])
  @@map("capa_tasks")
}

model CapaHistory {
  id                 String   @id @default(uuid())
  capaId             String   @map("capa_id")
  userId             String   @map("user_id")
  action             String
  timestamp          DateTime @default(now())
  details            Json?
  digitalSignatureId String?  @map("digital_signature_id")

  capa CAPA @relation(fields: [capaId], references: [id], onDelete: Restrict)
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([capaId])
  @@map("capa_history")
}

model CapaSignature {
  id               String   @id @default(uuid())
  capaId           String   @map("capa_id")
  signerId         String   @map("signer_id")
  signatureMeaning String   @map("signature_meaning")
  signedAt         DateTime @default(now()) @map("signed_at")
  recordHash       String   @map("record_hash")
  signatureHash    String   @map("signature_hash")
  passwordHash     String?  @map("password_hash")

  capa  CAPA  @relation(fields: [capaId], references: [id], onDelete: Restrict)
  signer User @relation(fields: [signerId], references: [id], onDelete: Restrict)

  @@map("capa_signatures")
}

model FileAsset {
  id           String    @id @default(uuid())
  storageKey   String    @map("storage_key")
  filename     String
  contentType  String    @map("content_type")
  sizeBytes    Int       @map("size_bytes")
  sha256       String?
  uploadedById String   @map("uploaded_by_id")
  isDeleted    Boolean   @default(false) @map("is_deleted")
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime @default(now()) @map("created_at")

  uploadedBy User      @relation(fields: [uploadedById], references: [id], onDelete: Restrict)
  fileLinks  FileLink[]
  formRecordPdf        FormRecord?

  @@map("file_assets")
}

model FileLink {
  id          String   @id @default(uuid())
  fileAssetId String   @map("file_asset_id")
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  purpose     String
  createdAt   DateTime @default(now()) @map("created_at")

  fileAsset FileAsset @relation(fields: [fileAssetId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId])
  @@map("file_links")
}

model EntityLink {
  id         String   @id @default(uuid())
  sourceType LinkEntityType @map("source_type")
  sourceId   String   @map("source_id")
  targetType LinkEntityType @map("target_type")
  targetId   String   @map("target_id")
  linkType   String   @map("link_type")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@map("entity_links")
}

enum FormRecordStatus {
  DRAFT
  FINAL
  VOID
}

enum RelatedEntityType {
  SOLICITATION
  CONTRACT
  CHANGE
  CAPA
  OTHER
}

model FormRecordCounter {
  prefix  String
  year    Int
  nextSeq Int    @default(1) @map("next_seq")

  @@id([prefix, year])
  @@map("form_record_counters")
}

model FormRecord {
  id                   String            @id @default(uuid())
  recordNumber         String            @unique @map("record_number")
  templateDocumentId   String            @map("template_document_id")
  templateCode         String            @map("template_code")
  templateVersionMajor Int               @map("template_version_major")
  templateVersionMinor Int               @map("template_version_minor")
  title                String
  status               FormRecordStatus  @default(DRAFT)
  payload              Json
  approvalTrail        Json?             @map("approval_trail")
  governanceSource     Json?             @map("governance_source")
  relatedEntityType    RelatedEntityType @map("related_entity_type")
  relatedEntityId      String            @map("related_entity_id")
  qmsHash              String?           @map("qms_hash")
  recordVersion        Int               @default(1) @map("record_version")
  createdById          String?           @map("created_by_id")
  updatedById          String?           @map("updated_by_id")
  finalizedById        String?           @map("finalized_by_id")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  finalizedAt          DateTime?         @map("finalized_at")
  lockedAt             DateTime?         @map("locked_at")
  pdfFileAssetId       String?           @unique @map("pdf_file_asset_id")

  templateDocument Document  @relation(fields: [templateDocumentId], references: [id], onDelete: Restrict)
  pdfFileAsset     FileAsset? @relation(fields: [pdfFileAssetId], references: [id], onDelete: SetNull)
  createdBy        User?      @relation("FormRecordCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy        User?      @relation("FormRecordUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  finalizedBy      User?      @relation("FormRecordFinalizedBy", fields: [finalizedById], references: [id], onDelete: SetNull)

  @@index([templateCode])
  @@index([relatedEntityType, relatedEntityId])
  @@index([status])
  @@index([templateDocumentId])
  @@map("form_records")
}

// --- Governance signature request/artifact (separate from QMS internal signing) ---
enum SignatureRequestStatus {
  PENDING
  SIGNED
  EXPIRED
  CANCELLED
}

enum GovernanceVerificationStatus {
  VERIFIED
  INVALID
  STALE
}

model SignatureRequest {
  id                  String                 @id @default(uuid())
  entityType          String                 @map("entity_type")
  entityId            String                 @map("entity_id")
  recordVersion       String                 @map("record_version")
  qmsHash             String                  @map("qms_hash")
  status              SignatureRequestStatus  @default(PENDING)
  governanceRequestId String?                @map("governance_request_id")
  requestedAt         DateTime               @default(now()) @map("requested_at")
  signedAt            DateTime?               @map("signed_at")
  createdById         String?                @map("created_by_id")
  notes               String?                @db.Text

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)
  artifacts SignatureArtifact[]

  @@index([entityType, entityId])
  @@index([status])
  @@map("signature_requests")
}

model SignatureArtifact {
  id                  String                      @id @default(uuid())
  entityType          String                      @map("entity_type")
  entityId            String                      @map("entity_id")
  recordVersion       String                      @map("record_version")
  qmsHash             String                      @map("qms_hash")
  signature           String                      @db.Text
  signedAt            DateTime                    @map("signed_at")
  signatureRequestId String?                     @map("signature_request_id")
  verifiedAt         DateTime?                   @map("verified_at")
  verificationStatus GovernanceVerificationStatus? @map("verification_status")

  signatureRequest SignatureRequest? @relation(fields: [signatureRequestId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@map("signature_artifacts")
}
