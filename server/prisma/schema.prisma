generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentType {
  SOP
  POLICY
  WORK_INSTRUCTION
  FORM
  OTHER
}

enum DocumentStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PENDING_APPROVAL
  PENDING_QUALITY_RELEASE
  EFFECTIVE
  OBSOLETE
  ARCHIVED
}

enum AssignmentTaskType {
  REVIEW
  APPROVAL
  QUALITY_RELEASE
}

enum AssignmentStatus {
  PENDING
  COMPLETED
  REJECTED
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Admin, Quality Manager, Manager, User
  permissions String[] @default([])
  users       User[]
}

model User {
  id        String   @id @default(uuid())
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String   @unique
  password  String // bcrypt hash
  roleId    Int      @map("role_id")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  documentsAuthored    Document[]          @relation("DocumentAuthor")
  documentHistoryItems DocumentHistory[]
  documentAssignments  DocumentAssignment[] @relation("DocumentAssignee")
  notifications        Notification[]
  documentRevisions    DocumentRevision[]
  documentSignatures   DocumentSignature[]
  changeControls       ChangeControl[]
  capasAssigned        CAPA[]            @relation("CAPAAssignee")

  @@map("users")
}

model Document {
  id                  String         @id @default(uuid())
  documentId          String         @map("doc_id") // e.g. MAC-SOP-014
  title               String
  documentType        DocumentType   @map("doc_type") // SOP, POLICY, WORK_INSTRUCTION, etc.
  versionMajor        Int            @default(1) @map("major_version")
  versionMinor        Int            @default(0) @map("minor_version")
  effectiveDate       DateTime?      @map("effective_date")
  status              DocumentStatus @default(DRAFT)
  content             String?        @db.Text // Markdown
  authorId            String         @map("author_id")
  supersedesDocumentId String?       @map("supersedes_document_id")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  author              User                @relation("DocumentAuthor", fields: [authorId], references: [id], onDelete: Restrict)
  supersedesDocument  Document?           @relation("DocumentSupersedes", fields: [supersedesDocumentId], references: [id], onDelete: SetNull)
  supersededBy        Document[]          @relation("DocumentSupersedes")
  history             DocumentHistory[]
  revisions           DocumentRevision[]
  signatures          DocumentSignature[]
  assignments         DocumentAssignment[]

  @@map("documents")
  @@index([documentId])
  @@unique([documentId, versionMajor, versionMinor], map: "document_version_unique")
}

model DocumentHistory {
  id               String   @id @default(uuid())
  documentId       String   @map("document_id")
  userId           String   @map("user_id")
  action           String
  timestamp        DateTime @default(now())
  details          Json?
  digitalSignature Json?    @map("digital_signature")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  user     User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("document_history")
}

model DocumentRevision {
  id              String   @id @default(uuid())
  documentId      String   @map("document_id")
  versionMajor    Int      @map("version_major")
  versionMinor    Int      @map("version_minor")
  effectiveDate   DateTime @map("effective_date")
  authorId        String   @map("author_id")
  summaryOfChange String   @map("summary_of_change")
  createdAt       DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  author   User     @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@map("document_revisions")
}

model DocumentSignature {
  id               String   @id @default(uuid())
  documentId       String   @map("document_id")
  signerId         String   @map("signer_id")
  signatureMeaning String   @map("signature_meaning")
  signedAt         DateTime @default(now()) @map("signed_at")
  documentHash     String   @map("document_hash")
  signatureHash    String   @map("signature_hash")
  passwordHash     String   @map("password_hash")

  document Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  signer   User     @relation(fields: [signerId], references: [id], onDelete: Restrict)

  @@map("document_signatures")
}

model DocumentAssignment {
  id            String                  @id @default(uuid())
  documentId    String                  @map("document_id")
  assignedToId  String                  @map("assignee_id")
  assignmentType AssignmentTaskType  @map("task_type")
  status        AssignmentStatus     @default(PENDING)
  dueDate       DateTime?               @map("due_date")
  completedAt   DateTime?               @map("completed_at")
  comments    String?            @db.Text
  createdAt   DateTime           @default(now()) @map("created_at")

  document   Document @relation(fields: [documentId], references: [id], onDelete: Restrict)
  assignedTo User     @relation("DocumentAssignee", fields: [assignedToId], references: [id], onDelete: Restrict)

  @@map("document_assignments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  message   String
  read      Boolean  @default(false) @map("is_read")
  link      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@map("notifications")
}

model ChangeControl {
  id             String   @id @default(uuid())
  title          String
  changeId       String   @map("change_id")
  description    String   @db.Text
  riskAssessment String?  @map("risk_assessment") @db.Text
  status         String // Pending, Approved, Rejected, Closed
  initiatorId    String?  @map("initiator_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  initiator User? @relation(fields: [initiatorId], references: [id], onDelete: SetNull)

  @@map("change_controls")
}

model CAPA {
  id          String   @id @default(uuid())
  title       String
  capaId      String   @map("capa_id")
  description String   @db.Text
  rootCause   String?  @map("root_cause") @db.Text
  status      String // Open, In Progress, Closed
  assigneeId  String?  @map("assignee_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  assignee User? @relation("CAPAAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@map("capas")
}
